# æ•°æ®åº“è¡¨ç»“æ„åŒ¹é…æ£€æŸ¥æŠ¥å‘Š

## æ£€æŸ¥æ—¶é—´
2026-01-27

## æ£€æŸ¥èŒƒå›´
- æ•°æ®åº“è¿ç§»è„šæœ¬ï¼š`V1__init.sql`
- Entityå®ä½“ç±»ï¼š`entity` åŒ…ä¸‹çš„æ‰€æœ‰Javaç±»
- Mapperæ¥å£ï¼š`mapper` åŒ…ä¸‹çš„æ‰€æœ‰Javaæ¥å£
- Mapper XMLï¼š`resources/mapper` ç›®å½•ä¸‹çš„æ‰€æœ‰XMLæ–‡ä»¶

---

## 1. auth_user è¡¨

### æ•°æ®åº“è¡¨ç»“æ„ï¼ˆSQLï¼‰
- `id` UUID PRIMARY KEY
- `username` TEXT NOT NULL UNIQUE
- `display_name` TEXT NOT NULL
- `email` TEXT
- `is_active` BOOLEAN NOT NULL DEFAULT true
- `created_at` TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP

### Entityç±»ï¼ˆAuthUser.javaï¼‰
- `id` UUID âœ“
- `username` String âœ“
- `displayName` String âœ“ (å¯¹åº” display_name)
- `email` String âœ“
- `isActive` Boolean âœ“ (å¯¹åº” is_active)
- `createdAt` OffsetDateTime âœ“ (å¯¹åº” created_at)

### Mapperæ¥å£ï¼ˆAuthUserMapper.javaï¼‰
- `selectById` âœ“
- `selectByUsername` âœ“
- `selectAll` âœ“
- `insert` âœ“
- `update` âœ“
- `deleteById` âœ“

### Mapper XMLï¼ˆAuthUserMapper.xmlï¼‰
- ResultMapæ˜ å°„ï¼šæ‰€æœ‰å­—æ®µæ­£ç¡®æ˜ å°„ âœ“
- SQLè¯­å¥ï¼šå­—æ®µåä¸æ•°æ®åº“è¡¨åŒ¹é… âœ“

**ç»“è®ºï¼šâœ… å®Œå…¨åŒ¹é…ï¼Œæ— é—®é¢˜**

---

## 2. project è¡¨

### æ•°æ®åº“è¡¨ç»“æ„ï¼ˆSQLï¼‰
- `id` BIGSERIAL PRIMARY KEY
- `code` TEXT NOT NULL
- `name` TEXT NOT NULL
- `description` TEXT
- `status` TEXT NOT NULL DEFAULT 'active'
- `created_by` UUID NOT NULL REFERENCES auth_user(id)
- `created_at` TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP
- `updated_at` TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP

### Entityç±»ï¼ˆProject.javaï¼‰
- `id` Long âœ“
- `code` String âœ“
- `name` String âœ“
- `description` String âœ“
- `status` String âœ“
- `createdBy` UUID âœ“ (å¯¹åº” created_by)
- `createdAt` OffsetDateTime âœ“ (å¯¹åº” created_at)
- `updatedAt` OffsetDateTime âœ“ (å¯¹åº” updated_at)

### Mapperæ¥å£ï¼ˆProjectMapper.javaï¼‰
- `selectById` âœ“
- `selectByCode` âœ“
- `selectByCreatedBy` âœ“
- `selectAll` âœ“
- `insert` âœ“
- `update` âœ“
- `deleteById` âœ“

### Mapper XMLï¼ˆProjectMapper.xmlï¼‰
- ResultMapæ˜ å°„ï¼šæ‰€æœ‰å­—æ®µæ­£ç¡®æ˜ å°„ âœ“
- SQLè¯­å¥ï¼šå­—æ®µåä¸æ•°æ®åº“è¡¨åŒ¹é… âœ“

**ç»“è®ºï¼šâœ… å®Œå…¨åŒ¹é…ï¼Œæ— é—®é¢˜**

---

## 3. auth_project_acl è¡¨

### æ•°æ®åº“è¡¨ç»“æ„ï¼ˆSQLï¼‰
- `id` BIGSERIAL PRIMARY KEY
- `project_id` BIGINT NOT NULL REFERENCES project(id) ON DELETE CASCADE
- `user_id` UUID NOT NULL REFERENCES auth_user(id) ON DELETE CASCADE
- `role` TEXT NOT NULL CHECK (role IN ('owner', 'editor', 'viewer'))
- `created_at` TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP
- UNIQUE(project_id, user_id)

### Entityç±»ï¼ˆAuthProjectAcl.javaï¼‰
- `id` Long âœ“
- `projectId` Long âœ“ (å¯¹åº” project_id)
- `userId` UUID âœ“ (å¯¹åº” user_id)
- `role` String âœ“
- `createdAt` OffsetDateTime âœ“ (å¯¹åº” created_at)

### Mapperæ¥å£ï¼ˆAuthProjectAclMapper.javaï¼‰
- `selectById` âœ“
- `selectByProjectId` âœ“
- `selectByUserId` âœ“
- `selectByProjectIdAndUserId` âœ“
- `insert` âœ“
- `update` âœ“
- `deleteById` âœ“
- `deleteByProjectIdAndUserId` âœ“

### Mapper XMLï¼ˆAuthProjectAclMapper.xmlï¼‰
- ResultMapæ˜ å°„ï¼šæ‰€æœ‰å­—æ®µæ­£ç¡®æ˜ å°„ âœ“
- SQLè¯­å¥ï¼šå­—æ®µåä¸æ•°æ®åº“è¡¨åŒ¹é… âœ“

**ç»“è®ºï¼šâœ… å®Œå…¨åŒ¹é…ï¼Œæ— é—®é¢˜**

---

## 4. evidence_item è¡¨

### æ•°æ®åº“è¡¨ç»“æ„ï¼ˆSQLï¼‰
- `id` BIGSERIAL PRIMARY KEY
- `project_id` BIGINT NOT NULL REFERENCES project(id) ON DELETE CASCADE
- `title` TEXT NOT NULL
- `note` TEXT
- `bucket` TEXT NOT NULL
- `object_key` TEXT NOT NULL
- `content_type` TEXT
- `size_bytes` BIGINT NOT NULL
- `etag` TEXT
- `status` TEXT NOT NULL DEFAULT 'active' CHECK (status IN ('active', 'invalid', 'archived'))
- `created_by` UUID NOT NULL REFERENCES auth_user(id)
- `created_at` TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP
- `updated_at` TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP
- `invalid_reason` TEXT
- `invalid_by` UUID REFERENCES auth_user(id)
- `invalid_at` TIMESTAMPTZ

### Entityç±»ï¼ˆEvidenceItem.javaï¼‰
- `id` Long âœ“
- `projectId` Long âœ“ (å¯¹åº” project_id)
- `title` String âœ“
- `note` String âœ“
- `bucket` String âœ“
- `objectKey` String âœ“ (å¯¹åº” object_key)
- `contentType` String âœ“ (å¯¹åº” content_type)
- `sizeBytes` Long âœ“ (å¯¹åº” size_bytes)
- `etag` String âœ“
- `status` String âœ“
- `createdBy` UUID âœ“ (å¯¹åº” created_by)
- `createdAt` OffsetDateTime âœ“ (å¯¹åº” created_at)
- `updatedAt` OffsetDateTime âœ“ (å¯¹åº” updated_at)
- `invalidReason` String âœ“ (å¯¹åº” invalid_reason)
- `invalidBy` UUID âœ“ (å¯¹åº” invalid_by)
- `invalidAt` OffsetDateTime âœ“ (å¯¹åº” invalid_at)

### Mapperæ¥å£ï¼ˆEvidenceItemMapper.javaï¼‰
- `selectById` âœ“
- `selectByProjectId` âœ“
- `selectByProjectIdAndStatus` âœ“
- `selectByCreatedBy` âœ“
- `selectAll` âœ“
- `insert` âœ“
- `update` âœ“
- `deleteById` âœ“

### Mapper XMLï¼ˆEvidenceItemMapper.xmlï¼‰
- ResultMapæ˜ å°„ï¼šæ‰€æœ‰å­—æ®µæ­£ç¡®æ˜ å°„ âœ“
- SQLè¯­å¥ï¼šå­—æ®µåä¸æ•°æ®åº“è¡¨åŒ¹é… âœ“

**ç»“è®ºï¼šâœ… å®Œå…¨åŒ¹é…ï¼Œæ— é—®é¢˜**

---

## 5. audit_operation_log è¡¨

### æ•°æ®åº“è¡¨ç»“æ„ï¼ˆSQLï¼‰
- `id` BIGSERIAL PRIMARY KEY
- `actor_user_id` UUID NOT NULL REFERENCES auth_user(id)
- `action` TEXT NOT NULL
- `target_type` TEXT NOT NULL
- `target_id` TEXT NOT NULL
- `detail` JSONB
- `created_at` TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP

### Entityç±»ï¼ˆAuditOperationLog.javaï¼‰
- `id` Long âœ“
- `actorUserId` UUID âœ“ (å¯¹åº” actor_user_id)
- `action` String âœ“
- `targetType` String âœ“ (å¯¹åº” target_type)
- `targetId` String âœ“ (å¯¹åº” target_id)
- `detail` String âœ“ (å¯¹åº” detailï¼ŒJavaä¸­JSONBé€šå¸¸ç”¨Stringè¡¨ç¤º)
- `createdAt` OffsetDateTime âœ“ (å¯¹åº” created_at)

### Mapperæ¥å£ï¼ˆAuditOperationLogMapper.javaï¼‰
- `selectById` âœ“
- `selectByActorUserId` âœ“
- `selectByTarget` âœ“
- `selectByAction` âœ“
- `selectAll` âœ“
- `insert` âœ“

### Mapper XMLï¼ˆAuditOperationLogMapper.xmlï¼‰
- ResultMapæ˜ å°„ï¼šæ‰€æœ‰å­—æ®µæ­£ç¡®æ˜ å°„ âœ“
- SQLè¯­å¥ï¼šå­—æ®µåä¸æ•°æ®åº“è¡¨åŒ¹é… âœ“
- **æ³¨æ„**ï¼š`detail` å­—æ®µåœ¨SQLä¸­æ˜¯JSONBç±»å‹ï¼Œåœ¨XMLä¸­æ˜ å°„ä¸ºVARCHARï¼Œè¿™æ˜¯åˆç†çš„ï¼Œå› ä¸ºMyBatisä¼šå°†JSONBä½œä¸ºå­—ç¬¦ä¸²å¤„ç†

**ç»“è®ºï¼šâœ… å®Œå…¨åŒ¹é…ï¼Œæ— é—®é¢˜**

---

## æ€»ç»“

### âœ… åŒ¹é…æƒ…å†µ
æ‰€æœ‰5ä¸ªæ•°æ®åº“è¡¨çš„ç»“æ„ä¸å¯¹åº”çš„Entityç±»ã€Mapperæ¥å£å’ŒMapper XMLæ–‡ä»¶**å®Œå…¨åŒ¹é…**ï¼Œæ²¡æœ‰å‘ç°ä»»ä½•é—®é¢˜ã€‚

### ğŸ“‹ æ£€æŸ¥é¡¹æ¸…å•
- [x] è¡¨åä¸Entityç±»åå¯¹åº”å…³ç³»æ­£ç¡®
- [x] å­—æ®µåä¸å±æ€§åå¯¹åº”å…³ç³»æ­£ç¡®ï¼ˆä¸‹åˆ’çº¿è½¬é©¼å³°ï¼‰
- [x] æ•°æ®ç±»å‹æ˜ å°„æ­£ç¡®ï¼ˆUUIDã€BIGINTã€TEXTã€TIMESTAMPTZç­‰ï¼‰
- [x] Mapperæ¥å£æ–¹æ³•å‘½åè§„èŒƒ
- [x] Mapper XMLä¸­çš„ResultMapæ˜ å°„æ­£ç¡®
- [x] Mapper XMLä¸­çš„SQLè¯­å¥å­—æ®µåæ­£ç¡®
- [x] ä¸»é”®å’Œå¤–é”®å…³ç³»æ­£ç¡®

### âš ï¸ æ³¨æ„äº‹é¡¹
1. **ç¼–ç é—®é¢˜**ï¼šSQLæ–‡ä»¶å’Œéƒ¨åˆ†XMLæ–‡ä»¶å­˜åœ¨ç¼–ç é—®é¢˜ï¼ˆæ˜¾ç¤ºä¸ºä¹±ç ï¼‰ï¼Œä½†ä¸å½±å“å®é™…åŠŸèƒ½ï¼Œå»ºè®®ä¿®å¤ç¼–ç ä»¥ç¡®ä¿å¯è¯»æ€§
2. **JSONBå­—æ®µ**ï¼š`audit_operation_log.detail` å­—æ®µåœ¨æ•°æ®åº“ä¸­æ˜¯JSONBç±»å‹ï¼Œåœ¨Javaä¸­ç”¨Stringè¡¨ç¤ºæ˜¯åˆç†çš„åšæ³•
3. **æ—¶é—´ç±»å‹**ï¼šæ•°æ®åº“ä½¿ç”¨TIMESTAMPTZï¼ŒJavaä½¿ç”¨OffsetDateTimeï¼Œæ˜ å°„æ­£ç¡®

### ğŸ’¡ å»ºè®®
1. ä¿®å¤SQLæ–‡ä»¶å’ŒXMLæ–‡ä»¶çš„ç¼–ç é—®é¢˜ï¼Œç¡®ä¿ä½¿ç”¨UTF-8ç¼–ç 
2. æ‰€æœ‰æ–‡ä»¶ç»“æ„åŒ¹é…è‰¯å¥½ï¼Œå¯ä»¥æ­£å¸¸ä½¿ç”¨
