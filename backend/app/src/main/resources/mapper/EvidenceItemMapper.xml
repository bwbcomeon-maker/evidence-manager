<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.bwbcomeon.evidence.mapper.EvidenceItemMapper">

    <resultMap id="BaseResultMap" type="com.bwbcomeon.evidence.entity.EvidenceItem">
        <id column="id" property="id" jdbcType="BIGINT"/>
        <result column="project_id" property="projectId" jdbcType="BIGINT"/>
        <result column="title" property="title" jdbcType="VARCHAR"/>
        <result column="note" property="note" jdbcType="VARCHAR"/>
        <result column="bucket" property="bucket" jdbcType="VARCHAR"/>
        <result column="object_key" property="objectKey" jdbcType="VARCHAR"/>
        <result column="content_type" property="contentType" jdbcType="VARCHAR"/>
        <result column="size_bytes" property="sizeBytes" jdbcType="BIGINT"/>
        <result column="etag" property="etag" jdbcType="VARCHAR"/>
        <result column="status" property="status" jdbcType="VARCHAR"/>
        <result column="evidence_status" property="evidenceStatus" jdbcType="VARCHAR"/>
        <result column="archived_time" property="archivedTime" jdbcType="TIMESTAMP"/>
        <result column="invalid_time" property="invalidTime" jdbcType="TIMESTAMP"/>
        <result column="biz_type" property="bizType" jdbcType="VARCHAR"/>
        <result column="created_by_user_id" property="createdByUserId" jdbcType="BIGINT"/>
        <result column="created_at" property="createdAt" jdbcType="TIMESTAMP"/>
        <result column="updated_at" property="updatedAt" jdbcType="TIMESTAMP"/>
        <result column="invalid_reason" property="invalidReason" jdbcType="VARCHAR"/>
        <result column="invalid_by_user_id" property="invalidByUserId" jdbcType="BIGINT"/>
        <result column="invalid_at" property="invalidAt" jdbcType="TIMESTAMP"/>
    </resultMap>

    <sql id="Base_Column_List">
        id, project_id, title, note, bucket, object_key, content_type, size_bytes, etag,
        status, evidence_status, archived_time, invalid_time, biz_type, created_by_user_id, created_at, updated_at, invalid_reason, invalid_by_user_id, invalid_at
    </sql>

    <select id="selectById" resultMap="BaseResultMap">
        SELECT
        <include refid="Base_Column_List"/>
        FROM evidence_item
        WHERE id = #{id}
    </select>

    <select id="selectByProjectId" resultMap="BaseResultMap">
        SELECT
        <include refid="Base_Column_List"/>
        FROM evidence_item
        WHERE project_id = #{projectId}
        ORDER BY created_at DESC
    </select>

    <select id="selectByProjectIdAndStatus" resultMap="BaseResultMap">
        SELECT
        <include refid="Base_Column_List"/>
        FROM evidence_item
        WHERE project_id = #{projectId}
        AND status = #{status}
        ORDER BY created_at DESC
    </select>

    <select id="selectByCreatedBy" resultMap="BaseResultMap">
        SELECT
        <include refid="Base_Column_List"/>
        FROM evidence_item
        WHERE created_by_user_id = #{createdByUserId}
        ORDER BY created_at DESC
    </select>

    <select id="selectAll" resultMap="BaseResultMap">
        SELECT
        <include refid="Base_Column_List"/>
        FROM evidence_item
        ORDER BY created_at DESC
    </select>

    <insert id="insert" parameterType="com.bwbcomeon.evidence.entity.EvidenceItem" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO evidence_item (
            project_id, title, note, bucket, object_key, content_type, size_bytes, etag,
            status, evidence_status, archived_time, invalid_time, biz_type, created_by_user_id, created_at, updated_at, invalid_reason, invalid_by_user_id, invalid_at
        )
        VALUES (
            #{projectId},
            #{title},
            #{note},
            #{bucket},
            #{objectKey},
            #{contentType},
            #{sizeBytes},
            #{etag},
            COALESCE(#{status}, 'active'),
            COALESCE(#{evidenceStatus}, 'SUBMITTED'),
            #{archivedTime},
            #{invalidTime},
            COALESCE(#{bizType}, 'OTHER'),
            #{createdByUserId},
            COALESCE(#{createdAt}, CURRENT_TIMESTAMP),
            COALESCE(#{updatedAt}, CURRENT_TIMESTAMP),
            #{invalidReason},
            #{invalidByUserId},
            #{invalidAt}
        )
    </insert>

    <update id="update" parameterType="com.bwbcomeon.evidence.entity.EvidenceItem">
        UPDATE evidence_item
        <set>
            <if test="title != null">title = #{title},</if>
            <if test="note != null">note = #{note},</if>
            <if test="bucket != null">bucket = #{bucket},</if>
            <if test="objectKey != null">object_key = #{objectKey},</if>
            <if test="contentType != null">content_type = #{contentType},</if>
            <if test="sizeBytes != null">size_bytes = #{sizeBytes},</if>
            <if test="etag != null">etag = #{etag},</if>
            <if test="status != null">status = #{status},</if>
            <if test="bizType != null">biz_type = #{bizType},</if>
            <if test="invalidReason != null">invalid_reason = #{invalidReason},</if>
            <if test="invalidByUserId != null">invalid_by_user_id = #{invalidByUserId},</if>
            <if test="invalidAt != null">invalid_at = #{invalidAt},</if>
            updated_at = CURRENT_TIMESTAMP
        </set>
        WHERE id = #{id}
    </update>

    <delete id="deleteById">
        DELETE FROM evidence_item
        WHERE id = #{id}
    </delete>

    <select id="selectByProjectIdWithFilters" resultMap="BaseResultMap">
        SELECT
        <include refid="Base_Column_List"/>
        FROM evidence_item
        WHERE project_id = #{projectId}
        <if test="nameLike != null and nameLike != ''">
            AND title LIKE CONCAT('%', #{nameLike}, '%')
        </if>
        <if test="status != null and status != ''">
            AND status = #{status}
        </if>
        <if test="bizType != null and bizType != ''">
            AND biz_type = #{bizType}
        </if>
        <if test="contentType != null and contentType != ''">
            AND content_type = #{contentType}
        </if>
        ORDER BY created_at DESC
    </select>

    <!-- 分页查询：仅限 projectIds 内，可选 projectId/status/createdBy/createdAfter/fileCategory/nameLike -->
    <sql id="PageWhereClause">
        <if test="projectIds != null and projectIds.size() > 0">
            AND project_id IN
            <foreach collection="projectIds" item="pid" open="(" separator="," close=")">
                #{pid}
            </foreach>
        </if>
        <if test="projectId != null">
            AND project_id = #{projectId}
        </if>
        <!-- 按 evidence_status 筛选：未传 status 时默认排除 INVALID（已作废） -->
        <choose>
            <when test="status != null and status != ''">
                AND COALESCE(evidence_status, status, '') = #{status}
            </when>
            <otherwise>
                AND COALESCE(evidence_status, 'SUBMITTED') != 'INVALID'
            </otherwise>
        </choose>
        <if test="createdByUserId != null">
            AND created_by_user_id = #{createdByUserId}
        </if>
        <if test="createdAfter != null">
            AND created_at &gt;= #{createdAfter}
        </if>
        <if test="fileCategory == 'image'">
            AND content_type LIKE 'image/%'
        </if>
        <if test="fileCategory == 'video'">
            AND content_type LIKE 'video/%'
        </if>
        <if test="fileCategory == 'document'">
            AND (
                content_type LIKE 'application/pdf'
                OR content_type LIKE 'application/msword'
                OR content_type LIKE 'application/vnd.openxmlformats-officedocument.%'
                OR content_type LIKE 'text/%'
                OR content_type IN ('application/zip', 'application/x-rar-compressed')
            )
        </if>
        <if test="nameLike != null and nameLike != ''">
            AND title ILIKE CONCAT('%', #{nameLike}, '%')
        </if>
    </sql>

    <select id="selectPageWithFilters" resultMap="BaseResultMap">
        SELECT
        <include refid="Base_Column_List"/>
        FROM evidence_item
        <where>
            <include refid="PageWhereClause"/>
        </where>
        ORDER BY created_at DESC
        OFFSET #{offset} LIMIT #{limit}
    </select>

    <select id="countPageWithFilters" resultType="long">
        SELECT COUNT(1)
        FROM evidence_item
        <where>
            <include refid="PageWhereClause"/>
        </where>
    </select>

    <!-- 状态流转：乐观约束，仅当前状态匹配时更新 -->
    <update id="updateEvidenceStatus">
        UPDATE evidence_item
        SET evidence_status = #{evidenceStatus},
            archived_time = #{archivedTime},
            invalid_time = #{invalidTime},
            updated_at = CURRENT_TIMESTAMP
        WHERE id = #{id}
          AND COALESCE(evidence_status, status, '') = #{expectedCurrentStatus}
    </update>

    <!-- 作废证据：写入 evidence_status/invalid_time/invalid_reason/invalid_by/invalid_at（时间优先 invalid_at），状态保护：仅当未作废时更新 -->
    <update id="updateEvidenceInvalidate">
        UPDATE evidence_item
        SET evidence_status = #{evidenceStatus},
            invalid_time = #{invalidTime},
            invalid_reason = #{invalidReason},
            invalid_by_user_id = #{invalidByUserId},
            invalid_at = #{invalidAt},
            updated_at = CURRENT_TIMESTAMP
        WHERE id = #{id}
          AND COALESCE(evidence_status, '') &lt;&gt; 'INVALID'
    </update>

</mapper>
