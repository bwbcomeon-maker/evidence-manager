# 证据管理界面实现说明

## 一、修改/新增的前端文件路径

### 新增文件（2个）

1. **API层**
   - `api/evidence.ts` - 证据相关API封装

2. **文档**
   - `证据管理界面实现说明.md` - 本文档

### 修改文件（1个）

1. **视图层**
   - `views/ProjectDetail.vue` - 添加"证据"Tab，实现完整的证据管理功能

---

## 二、功能实现

### 1. 证据列表

**实现位置**：`ProjectDetail.vue` - "证据" Tab

**功能**：
- 使用 `GET /api/projects/{projectId}/evidences` 获取证据列表
- 展示字段：
  - `title`：证据标题
  - `bizType`：业务类型（显示中文：方案/报告/纪要/测试/验收/其他）
  - 文件类型：根据 `contentType` 显示（PDF/Word/Excel/图片）
  - 最新版本号：`latestVersion.versionNo`
  - 更新时间：格式化显示

**组件**：
- `van-list`：列表展示
- `van-pull-refresh`：下拉刷新
- `van-cell`：列表项

---

### 2. 筛选功能

**实现位置**：`ProjectDetail.vue` - 筛选栏

**功能**：
- **bizType 筛选**：下拉选择业务类型
  - 选项：全部类型、方案、报告、纪要、测试、验收、其他
- **contentType 筛选**：下拉选择文件类型
  - 选项：全部格式、PDF、Word、Excel、图片

**组件**：
- `van-dropdown-menu`：下拉菜单容器
- `van-dropdown-item`：下拉选项

**筛选逻辑**：
- 选择筛选条件后，自动刷新列表
- 支持组合筛选（bizType + contentType）

---

### 3. 下载功能

**实现位置**：`ProjectDetail.vue` - 列表项右侧"下载"按钮

**功能**：
- 点击"下载"按钮
- 调用 `GET /api/evidence/versions/{versionId}/download`
- 浏览器自动下载文件
- 显示下载进度提示

**实现细节**：
```typescript
const handleDownload = async (evidence: EvidenceListItem) => {
  const blob = await downloadVersionFile(evidence.latestVersion.versionId)
  const url = window.URL.createObjectURL(blob)
  const link = document.createElement('a')
  link.href = url
  link.download = evidence.latestVersion.originalFilename
  link.click()
  window.URL.revokeObjectURL(url)
}
```

---

### 4. 上传功能

**实现位置**：`ProjectDetail.vue` - "上传证据"按钮 + Dialog

**功能**：
- 点击"上传证据"按钮，弹出 Dialog
- 表单字段：
  - `title`：证据标题（必填）
  - `type`：业务类型（选择器，默认"其他"）
  - `remark`：备注（可选）
  - `file`：文件（必填，使用 van-uploader）

**组件**：
- `van-dialog`：上传对话框
- `van-form`：表单容器
- `van-field`：表单字段
- `van-uploader`：文件选择器
- `van-picker`：业务类型选择器（底部弹出）

**上传逻辑**：
- 调用 `POST /api/projects/{projectId}/evidences`
- 使用 `FormData` 提交 multipart/form-data
- 上传成功后关闭 Dialog，刷新列表

---

## 三、API 封装

### evidence.ts

```typescript
// 获取证据列表
export const getEvidenceList = (projectId: number, params?: EvidenceListParams)

// 上传证据
export const uploadEvidence = (projectId: number, formData: FormData)

// 下载证据版本文件
export const downloadVersionFile = (versionId: number)
```

**接口说明**：
- 所有接口使用统一的 `http` 实例（axios）
- 下载接口返回 `Blob` 类型
- 响应拦截器自动处理 blob 响应

---

## 四、业务类型映射

```typescript
const bizTypeMap: Record<string, string> = {
  PLAN: '方案',
  REPORT: '报告',
  MINUTES: '纪要',
  TEST: '测试',
  ACCEPTANCE: '验收',
  OTHER: '其他'
}
```

**使用**：将后端返回的大写业务类型转换为中文显示

---

## 五、文件类型识别

```typescript
const getFileTypeText = (contentType: string) => {
  if (contentType?.includes('pdf')) return 'PDF'
  if (contentType?.includes('wordprocessingml')) return 'Word'
  if (contentType?.includes('spreadsheetml')) return 'Excel'
  if (contentType?.includes('image')) return '图片'
  return '文件'
}
```

**说明**：根据 MIME 类型判断文件类型并显示

---

## 六、手工验证步骤

### 步骤1：启动前端服务

```bash
cd frontend
npm run dev
```

访问：`http://localhost:5173`

### 步骤2：进入项目详情页

1. 从项目列表进入项目详情页
2. 切换到"证据"Tab

**预期**：
- 显示筛选栏（业务类型、文件类型）
- 显示"上传证据"按钮
- 显示证据列表（如果有数据）

---

### 步骤3：上传证据

1. 点击"上传证据"按钮
2. 填写表单：
   - 证据标题：`测试报告`
   - 业务类型：选择"报告"
   - 备注：`这是一个测试报告`
   - 选择文件：选择一个 PDF 文件
3. 点击"确定"按钮

**预期**：
- 显示"上传中..."提示
- 上传成功后显示"上传成功"
- Dialog 自动关闭
- 证据列表自动刷新，显示新上传的证据

---

### 步骤4：查看证据列表

**预期显示**：
- 证据标题：`测试报告`
- 标签信息：
  - 类型：报告
  - 格式：PDF
  - 版本：v1
  - 更新：1-27 14:30
- 右侧"下载"按钮

---

### 步骤5：筛选证据

#### 5.1 按业务类型筛选

1. 点击"业务类型"下拉菜单
2. 选择"报告"

**预期**：
- 列表自动刷新
- 只显示业务类型为"报告"的证据

#### 5.2 按文件类型筛选

1. 点击"文件类型"下拉菜单
2. 选择"PDF"

**预期**：
- 列表自动刷新
- 只显示文件类型为 PDF 的证据

#### 5.3 组合筛选

1. 同时选择"报告"和"PDF"

**预期**：
- 列表自动刷新
- 只显示同时满足两个条件的证据

---

### 步骤6：下载证据

1. 点击证据列表项右侧的"下载"按钮

**预期**：
- 显示"下载中..."提示
- 浏览器自动下载文件
- 文件名：`originalFilename`（如 `report.pdf`）
- 下载成功后显示"下载成功"

---

### 步骤7：下拉刷新

1. 在证据列表页面下拉

**预期**：
- 显示刷新动画
- 列表自动刷新
- 显示最新的证据数据

---

## 七、异常场景验证

### 场景1：上传失败

**操作**：
- 不填写证据标题，直接上传

**预期**：
- 显示"请输入证据标题"提示
- 不提交请求

---

### 场景2：下载失败

**操作**：
- 尝试下载一个不存在的版本文件

**预期**：
- 显示错误提示（如"下载失败"）
- 不触发文件下载

---

### 场景3：列表为空

**操作**：
- 筛选条件导致没有数据

**预期**：
- 显示"暂无证据"空状态提示

---

## 八、注意事项

1. **Tab 切换**：
   - 切换到"证据"Tab 时自动加载列表
   - 使用 `watch` 监听 Tab 切换

2. **文件上传**：
   - 使用 `FormData` 提交 multipart/form-data
   - 文件字段名为 `file`

3. **下载文件**：
   - 使用 `Blob` 和 `URL.createObjectURL` 创建下载链接
   - 下载后及时释放 URL 对象

4. **筛选逻辑**：
   - 筛选条件变化时自动刷新列表
   - 支持清空筛选（选择"全部"）

5. **业务类型选择**：
   - 使用底部弹出选择器（`van-picker`）
   - 默认值为"其他"（OTHER）

---

## 九、代码结构

```
frontend/src/
├── api/
│   ├── http.ts          # Axios 封装
│   └── evidence.ts      # 证据相关 API（新增）
├── views/
│   └── ProjectDetail.vue # 项目详情页（修改，添加证据Tab）
└── ...
```

---

**实现完成！证据管理界面已实现，支持列表展示、筛选、上传、下载等完整功能。**
