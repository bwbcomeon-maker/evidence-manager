# 用户管理「禁止自我操作」— 人工测试步骤

本文用于验证：任何登录用户（含 SYSTEM_ADMIN）均无法在用户管理中对**自己**执行禁用/启用/删除/改角色/重置密码；admin 不能修改 admin 自己任何字段；前端防呆与后端 403 一致。

---

## 前提

- 已存在可登录的 admin（若曾误禁用，先执行 [docs/db/admin-recover.md](../db/admin-recover.md) 中的 break-glass 脚本恢复）。
- 至少存在一个其他用户（如 pmo1），用于对比「操作他人」可成功。

---

## 一、admin 登录 → 用户管理 → 自己这一行

1. 使用 **admin / Admin@12345** 登录，进入「用户管理」。
2. 在列表中找到 **admin** 这一行。
3. **预期**：
   - 该行显示「当前登录」或类似标识。
   - **无**启用/禁用开关（或显示「不可操作」），无「重置密码」「删除」按钮。
   - 有「查看」或「编辑」按钮；点击后进入编辑/查看弹窗。
4. 点击「查看」或「编辑」进入 admin 自己的编辑弹窗。
5. **预期**：
   - 标题为「查看自己的账号」或类似。
   - 有提示条：「管理员模块不允许编辑自己的账号，如需修改请由其他管理员操作或使用自助改密。」
   - 姓名/手机/邮箱/角色/启用 等均为**不可编辑**（置灰或只读）。
   - **无**「保存」按钮（或保存不可用）。
6. 关闭弹窗。

**失败排查**：若仍出现禁用/删除/重置密码按钮，检查前端 `isSelf(u)` 是否依赖 `auth.currentUser`；确认进入页面时已拉取当前用户（如 MainLayout 的 fetchMe）。

---

## 二、接口绕过 UI：admin 对自己操作应 403

使用浏览器开发者工具或 curl，在已登录 admin 的 Session 下调用接口，**预期均为 403**，且返回文案含「不允许对自己的账号执行该操作」。

1. **修改自己**（将 admin 的 realName 改为任意值）  
   `PUT /api/admin/users/{admin_id}`  
   Body: `{ "realName": "x", "roleCode": "SYSTEM_ADMIN", "enabled": true }`  
   - 预期：HTTP 403，message 含「不允许对自己的账号执行该操作（请联系其他管理员）」。

2. **禁用自己**  
   `PATCH /api/admin/users/{admin_id}/enable`  
   Body: `{ "enabled": false }`  
   - 预期：HTTP 403，同上。

3. **重置自己密码**  
   `POST /api/admin/users/{admin_id}/reset-password`  
   - 预期：HTTP 403，同上。

4. **删除自己**  
   `DELETE /api/admin/users/{admin_id}`  
   - 预期：HTTP 403，同上。

其中 `{admin_id}` 为 admin 用户在 sys_user 中的 id（可从列表接口或数据库查）。

**失败排查**：查后端日志是否有 `SELF_OPERATION_FORBIDDEN` 审计；查 `audit_log` 表 action 是否为 `SELF_OPERATION_FORBIDDEN`。

---

## 三、admin 操作其他用户应成功

1. 在用户管理中，对**非 admin** 用户（如 pmo1）：
   - 点击「编辑」，修改姓名或角色后保存 → 预期成功。
   - 切换启用/禁用开关 → 预期成功。
   - 点击「重置密码」→ 预期成功并展示新密码。
2. **预期**：上述操作均返回 200，无 403。

---

## 四、非 admin 登录（若未来开放非 admin 进用户管理）

若存在其他角色（如 PMO）可访问用户管理：
- 使用该账号登录，进入用户管理，找到**自己**这一行。
- **预期**：与自己相关的禁用/删除/重置密码/改角色均不可操作（前端隐藏或置灰），且接口调用自己时返回 403。

当前仅 SYSTEM_ADMIN 可进用户管理，此步可在角色扩展后补充。

---

## 五、Break-glass 恢复脚本（开发/测试环境）

1. 在用户管理中用 admin 将自己禁用（若前端已防呆，可通过接口调用禁用自己，或直接在数据库将 admin 的 `enabled` 置为 false）。
2. 确认 admin 无法登录。
3. 按 [docs/db/admin-recover.md](../db/admin-recover.md) 执行 **admin_recover_dev.sql**。
4. 重启后端，使用 admin / Admin@12345 登录。
5. **预期**：登录成功，且用户管理中 admin 行为仍符合「一」中描述（自己只读、无危险操作按钮）。

---

## 六、步骤与预期汇总

| 步骤 | 操作 | 预期 |
|------|------|------|
| 一 | admin 看自己这一行 | 无禁用/删除/重置密码；编辑为只读+提示 |
| 二 | 接口：admin 改/禁/重置密码/删自己 | 403，文案含「不允许对自己的账号执行该操作」 |
| 三 | admin 编辑/禁用/重置他人 | 200 成功 |
| 四 | 非 admin 进用户管理时自己行 | 同 R1，不可操作自己 |
| 五 | 误禁用后执行 admin_recover_dev.sql | admin 可重新登录 |

完成以上步骤即覆盖「禁止自我操作」与 break-glass 恢复的人工验证。
